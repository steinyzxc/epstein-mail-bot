tokens:
  yc-token:
    service_connection: default-service-connection
    scope: repo

workflows:
  deploy:
    tasks:
      - name: deploy-function
        cubes:
          - name: get-iam-token
            env:
              ID_TOKEN: ${{ tokens.yc-token.id_token }}
              YC_SA_ID: ${{ tokens.yc-token.service_account_id }}
            image: cr.yandex/sourcecraft/yc-iam:latest

          - name: deploy
            env:
              YC_IAM_TOKEN: ${{ cubes.get-iam-token.outputs.IAM_TOKEN }}
              YC_FOLDER_ID: ${{ tokens.yc-token.folder_id }}
              LOCKBOX_SECRET_ID: ${{ secrets.LOCKBOX_SECRET_ID }}
            image:
              name: cr.yandex/sourcecraft/yc-cli:latest
              entrypoint: ""
            script:
              - |
                yc config set folder-id $YC_FOLDER_ID
                
                # Create deployment package
                zip -r function.zip index.py ids.txt requirements.txt
                
                # Deploy new version - secrets fetched from Lockbox at runtime
                yc serverless function version create \
                  --function-name=epstein-bot \
                  --runtime=python314 \
                  --entrypoint=index.handler \
                  --memory=384m \
                  --execution-timeout=7s \
                  --source-path=function.zip \
                  --secret environment-variable=BOT_TOKEN,id=$LOCKBOX_SECRET_ID,key=BOT_TOKEN \
                  --secret environment-variable=TG_SECRET_TOKEN,id=$LOCKBOX_SECRET_ID,key=TG_SECRET_TOKEN

on:
  push:
    - deploy
